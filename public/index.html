<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã</title>
  <style>
    body { font-family: system-ui, Arial; margin: 24px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; align-items:center; }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; max-width:520px; }
    #wheelWrap { width: 280px; height: 280px; position: relative; margin: 12px auto; }
    #wheel {
      width: 280px; height: 280px; border-radius: 50%;
      border: 10px solid #222; box-sizing: border-box;
      transform: rotate(0deg);
      transition: transform 0s;
      background: conic-gradient(#f2f2f2 0 180deg, #d9d9d9 180deg 360deg);
    }
    #pointer {
      position:absolute; top:-8px; left:50%; transform: translateX(-50%);
      width:0; height:0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-bottom: 24px solid #e11;
    }
    .muted { color:#666; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #222; background:#fff; cursor:pointer; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    #result { font-size: 20px; font-weight: 700; }
    code { background:#f5f5f5; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="row">
    <div class="card">
      <div><b id="question">–í–æ–ø—Ä–æ—Å</b></div>
      <div class="muted">–¢–≤–æ–π ID: <code id="myId">...</code></div>
      <div class="muted">–û—á–µ—Ä–µ–¥—å: <span id="queueLen">0</span></div>
      <div class="muted">–°–µ–π—á–∞—Å —Ö–æ–¥: <code id="turnId">...</code></div>
      <div style="margin-top:12px">
        <button id="spinBtn" disabled>–ö—Ä—É—Ç–∏—Ç—å</button>
      </div>
      <div style="margin-top:12px">
        –†–µ–∑—É–ª—å—Ç–∞—Ç: <span id="result">‚Äî</span>
      </div>
      <div class="muted" id="hint" style="margin-top:10px">–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è‚Ä¶</div>
    </div>

    <div class="card">
      <div id="wheelWrap">
        <div id="pointer"></div>
        <div id="wheel"></div>
      </div>
      <div class="muted" style="text-align:center">
        –°–µ–∫—Ç–æ—Ä–∞: <b>–î–∞</b> / <b>–ù–µ—Ç</b>
      </div>
    </div>
  </div>

  <!-- Socket.IO –∫–ª–∏–µ–Ω—Ç –±–µ—Ä—ë–º —Å —Å–µ—Ä–≤–µ—Ä–∞, —á—Ç–æ–±—ã –≤–µ—Ä—Å–∏–∏ —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–ª–∏ -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const elQuestion = document.getElementById("question");
    const elMyId = document.getElementById("myId");
    const elQueueLen = document.getElementById("queueLen");
    const elTurnId = document.getElementById("turnId");
    const elResult = document.getElementById("result");
    const elHint = document.getElementById("hint");
    const spinBtn = document.getElementById("spinBtn");
    const wheel = document.getElementById("wheel");

    let myId = null;
    let currentTurnId = null;
    let spinning = false;

    const socket = io({ transports: ["websocket", "polling"] });

    function setHint(t){ elHint.textContent = t; }
    function canSpin(){ return myId && currentTurnId && myId === currentTurnId && !spinning; }
    function updateButton(){
      spinBtn.disabled = !canSpin();
      if (!myId) return;
      if (spinning) setHint("–ö—Ä—É—Ç–∏—Ç—Å—è‚Ä¶ –≤—Å–µ —Å–º–æ—Ç—Ä—è—Ç üôÇ");
      else if (myId === currentTurnId) setHint("–¢–≤–æ—è –æ—á–µ—Ä–µ–¥—å! –ù–∞–∂–∏–º–∞–π ¬´–ö—Ä—É—Ç–∏—Ç—å¬ª.");
      else setHint("–ñ–¥–∏ —Å–≤–æ–µ–π –æ—á–µ—Ä–µ–¥–∏ –∏ —Å–º–æ—Ç—Ä–∏ –≤—Ä–∞—â–µ–Ω–∏–µ.");
    }

    function animateSpinToResult(resultIndex, durationMs){
      const sectorStart = resultIndex === 0 ? 0 : 180;
      const sectorEnd   = resultIndex === 0 ? 180 : 360;
      const targetInSector = sectorStart + (sectorEnd - sectorStart) * 0.5;
      const extraTurns = 6;
      const finalDeg = extraTurns * 360 + (360 - targetInSector);
      wheel.style.transition = `transform ${durationMs}ms cubic-bezier(0.12, 0.7, 0.12, 1)`;
      wheel.style.transform = `rotate(${finalDeg}deg)`;
    }

    socket.on("hello", (msg) => {
      myId = msg.id;
      elMyId.textContent = myId;
      updateButton();
    });

    socket.on("state", (st) => {
      elQuestion.textContent = st.question || "–í–æ–ø—Ä–æ—Å";
      elQueueLen.textContent = st.queueLength ?? 0;
      currentTurnId = st.currentTurnId || null;
      elTurnId.textContent = currentTurnId || "‚Äî";
      spinning = !!st.spinning;
      updateButton();
    });

    socket.on("spin_start", () => {
      spinning = true;
      elResult.textContent = "‚Äî";
      wheel.style.transition = "transform 0s";
      wheel.style.transform = "rotate(0deg)";
      updateButton();
    });

    socket.on("spin_result", (msg) => {
      const durationMs = 4500;
      animateSpinToResult(msg.resultIndex, durationMs);
      setTimeout(() => {
        elResult.textContent = msg.resultValue;
        spinning = false;
        updateButton();
      }, durationMs + 50);
    });

    socket.on("error_msg", (e) => {
      if (e?.error === "not_your_turn") setHint("–°–µ–π—á–∞—Å –Ω–µ —Ç–≤–æ—è –æ—á–µ—Ä–µ–¥—å.");
    });

    spinBtn.addEventListener("click", () => {
      if (!canSpin()) return;
      socket.emit("spin");
    });
  </script>
</body>
</html>
